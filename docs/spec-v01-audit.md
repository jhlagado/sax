# ZAX v0.1 Spec Audit Matrix (Tranche 1)

This document maps `docs/zax-spec.md` requirements to implementation evidence (tests/fixtures) or explicit current limits.

Scope of this tranche:

- Core assembler pipeline and language constructs used by current examples.
- Hard evidence via existing automated tests.
- Explicitly called out gaps where the spec is broader than current implementation.

Legend:

- `Implemented`: behavior exists and has test evidence.
- `Implemented (subset)`: behavior exists with explicit subset limits.
- `Intentionally rejected`: parser/lowering emits stable diagnostics.
- `Open`: not yet fully validated against spec text.

## 1) Lexical + Program Structure

| Spec area                                       | Status               | Evidence                                                                                                         |
| ----------------------------------------------- | -------------------- | ---------------------------------------------------------------------------------------------------------------- |
| `1.3` identifiers / keyword parsing             | Implemented          | `test/pr4_negative.test.ts`, `test/pr30_case_without_select.zax` (via structured-control parser tests)           |
| `1.4` literals (`dec/hex/bin/char`)             | Implemented (subset) | `test/pr2_binary_literals.test.ts`, `test/pr35_char_literals.test.ts`, `test/pr36_imm_char_escape_forms.test.ts` |
| `2.1` module file shape                         | Implemented          | `test/pr1_minimal.test.ts`, `test/examples_compile.test.ts`                                                      |
| `2.2` sections + counters + overlap diagnostics | Implemented          | `test/pr9_sections_align.test.ts`                                                                                |

## 2) Imports + Names

| Spec area                               | Status               | Evidence                                                       |
| --------------------------------------- | -------------------- | -------------------------------------------------------------- |
| `3.1` import syntax/resolution          | Implemented          | `test/pr10_imports.test.ts`, `test/pr11_include_dirs.test.ts`  |
| `3.2` collisions/visibility diagnostics | Implemented (subset) | `test/pr3_var_duplicates.test.ts`, `test/pr4_negative.test.ts` |

## 3) Types + Data

| Spec area                                     | Status               | Evidence                                                                                                                                      |
| --------------------------------------------- | -------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| `4.1` scalar built-ins (`byte/word/addr/ptr`) | Implemented          | `test/semantics_layout.test.ts`, `test/pr52_ptr_scalar_slots.test.ts`                                                                         |
| `4.2` aliases + size usage                    | Implemented (subset) | `test/pr8_sizeof.test.ts`                                                                                                                     |
| `4.3` enums                                   | Implemented          | `test/pr4_enum.test.ts`, `test/pr215_const_data_followups_matrix.test.ts`, `test/pr216_parser_remaining_decl_control_recovery_matrix.test.ts` |
| `4.4` consts                                  | Implemented          | `test/pr2_const_data.test.ts`, `test/pr2_div_zero.test.ts`, `test/pr215_const_data_followups_matrix.test.ts`                                  |
| `5.1` arrays (fixed + inferred for `data`)    | Implemented (subset) | `test/pr51_data_inferred_array_len.test.ts`, `test/pr54_inferred_array_len_invalid.test.ts`                                                   |
| `5.2` records                                 | Implemented (subset) | `test/semantics_layout.test.ts`, `test/pr217_parser_decl_minimum_shape_and_eof_recovery.test.ts`                                              |
| `5.3` unions                                  | Implemented (subset) | `test/pr50_union_field_access.test.ts`, `test/pr217_parser_decl_minimum_shape_and_eof_recovery.test.ts`                                       |
| `6.2` `var` storage                           | Implemented          | `test/pr3_var_layout.test.ts`                                                                                                                 |
| `6.3` `data` storage                          | Implemented          | `test/pr2_const_data.test.ts`                                                                                                                 |
| `6.4` `bin` / `hex` ingestion                 | Implemented          | `test/pr17_bin_hex_ingestion.test.ts`                                                                                                         |
| `6.5` `extern ... at`                         | Implemented          | `test/pr12_calls.test.ts`, `test/pr216_parser_remaining_decl_control_recovery_matrix.test.ts`                                                 |

## 4) Expressions + Fixups

| Spec area                               | Status               | Evidence                                                                                                   |
| --------------------------------------- | -------------------- | ---------------------------------------------------------------------------------------------------------- |
| `7.0` forward refs + fixups             | Implemented          | `test/pr37_forward_label_fixups.test.ts`, `test/pr37_fixup_negative.test.ts`                               |
| `7.1` `imm` arithmetic/eval diagnostics | Implemented (subset) | `test/pr2_binary_literals.test.ts`, `test/pr2_div_zero.test.ts`, `test/pr35_char_literals_invalid.test.ts` |
| `7.2` `ea` forms                        | Implemented (subset) | `test/pr43_ld_mem_imm8.test.ts`, `test/pr48_ld_mem_imm16.test.ts`, `test/parser_nested_index.test.ts`      |

## 5) Functions + Calling + Stack

| Spec area                                   | Status               | Evidence                                                                                                                                                                                         |
| ------------------------------------------- | -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `8.1` function declarations                 | Implemented          | `test/pr1_minimal.test.ts`, `test/pr12_calls.test.ts`                                                                                                                                            |
| `8.2` calling convention (current subset)   | Implemented (subset) | `test/pr12_calls.test.ts`, `test/pr52_ptr_scalar_slots.test.ts`                                                                                                                                  |
| `8.3` asm-call lowering (`func` / `extern`) | Implemented (subset) | `test/pr12_calls.test.ts`                                                                                                                                                                        |
| `8.4` locals + epilogue rewriting           | Implemented          | `test/pr14_frame_epilogue.test.ts`, `test/pr23_lowering_safety.test.ts`                                                                                                                          |
| `8.5` SP mutation safety checks             | Implemented (subset) | `test/pr23_lowering_safety.test.ts`, `test/pr92_lowering_interactions.test.ts`, `test/pr198_lowering_unknown_stack_states.test.ts`, `test/pr218_lowering_retcc_unknown_untracked_matrix.test.ts` |

## 6) Ops + Structured Control

| Spec area                                                  | Status               | Evidence                                                                          |
| ---------------------------------------------------------- | -------------------- | --------------------------------------------------------------------------------- |
| `9.2/9.3/9.4` `op` definitions + matcher/overload behavior | Implemented (subset) | `test/pr16_ops.test.ts`                                                           |
| `9.5` autosave/clobber policy                              | Implemented (subset) | `test/pr16_ops.test.ts`, `test/pr23_lowering_safety.test.ts`                      |
| `10.1/10.2` `if/while/repeat/select`                       | Implemented          | `test/pr15_structured_control.test.ts`                                            |
| `10.2.1` stacked `case` labels                             | Implemented          | `test/pr15_structured_control.test.ts` (`pr28_*` fixtures)                        |
| control-flow stack join diagnostics                        | Implemented          | `test/pr15_structured_control.test.ts`, `test/pr92_lowering_interactions.test.ts` |

## 7) ISA + Output Contracts

| Spec area                                     | Status               | Evidence                                                                                                                                                                        |
| --------------------------------------------- | -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ISA core + advanced subsets                   | Implemented (subset) | `test/pr24_isa_core.test.ts`, `test/pr25_isa_advanced.test.ts`, `test/pr56_isa_misc.test.ts`, `test/pr57_isa_im_rst.test.ts`, `test/pr91_isa_hl16_adc_sbc.test.ts`              |
| indexed/ED block/system instruction slices    | Implemented (subset) | `test/isa_indexed_*.test.ts`, `test/isa_block_*.test.ts`, `test/isa_ed_misc.test.ts`                                                                                            |
| `.hex/.bin/.d8dbg.json/.lst` artifact outputs | Implemented          | `test/cli_artifacts.test.ts`, `test/cli_contract_matrix.test.ts`, `test/cli_path_parity_contract.test.ts`, `test/pr39_listing.test.ts`, `test/pr195_hex_sparse_records.test.ts` |
| determinism                                   | Implemented          | `test/determinism_artifacts.test.ts`, `test/cli_determinism_contract.test.ts`, `test/cli_path_parity_contract.test.ts`, `test/examples_compile.test.ts`                         |

## 8) Tranche 2 Normative Mapping (high-risk sections)

This section maps specific normative statements to implementation evidence or explicit diagnostics.

### 8.1 `7.2 ea` forms and lowering constraints

| Normative intent                                                      | Status                 | Evidence / Diagnostic                                                                                                                                                                     |
| --------------------------------------------------------------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Absolute `ea` symbols lower to abs16 forms where encodable            | Implemented (subset)   | `test/pr43_ld_mem_imm8.test.ts`, `test/pr48_ld_mem_imm16.test.ts`, `test/pr49_ld_mem_imm16_abs_fastpath.test.ts`                                                                          |
| Indexed forms `(ix+disp)/(iy+disp)` accepted for covered instructions | Implemented (subset)   | `test/isa_indexed_ld.test.ts`, `test/isa_indexed_incdec.test.ts`, `test/isa_indexed_bitops.test.ts`, `test/isa_indexed_rotates.test.ts`, `test/pr201_isa_indexed_zero_disp_forms.test.ts` |
| Nested indexed `ea` forms are not currently lowered                   | Intentionally rejected | diagnostic: `Nested indexed addresses are not supported yet.` (see `test/pr12_calls.test.ts`)                                                                                             |
| Non-constant index components are rejected                            | Intentionally rejected | diagnostic: `Non-constant array indices are not supported yet.`                                                                                                                           |

### 8.2 `8.4/8.5` stack frame and SP safety rules

| Normative intent                                                                | Status                 | Evidence / Diagnostic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ------------------------------------------------------------------------------- | ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Locals use SP-relative slots and synthetic epilogue cleanup                     | Implemented            | `test/pr14_frame_epilogue.test.ts`, `test/pr23_lowering_safety.test.ts`                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Terminal `ret` paths avoid dead epilogue jumps                                  | Implemented            | `test/pr14_frame_epilogue.test.ts` (`pr14_terminal_ret_no_dead_jump`)                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `ret cc`/`ret` paths with locals rewrite to one shared epilogue target          | Implemented            | `test/pr14_frame_epilogue.test.ts`, `test/pr26_rotate_retcc.test.ts`, `test/pr222_lowering_retcc_epilogue_positive_matrix.test.ts` (includes multi-slot locals and stack-neutral op expansion paths)                                                                                                                                                                                                                                                                                                                             |
| Fallthrough with locals flows into cleanup epilogue                             | Implemented            | `test/pr23_lowering_safety.test.ts` (`pr23_implicit_ret_with_locals`)                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `ret` / `ret cc` with non-zero tracked stack delta is rejected                  | Intentionally rejected | diagnostic: `ret with non-zero tracked stack delta` (`test/pr23_lowering_safety.test.ts`)                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Function fallthrough with non-zero stack delta is rejected                      | Intentionally rejected | diagnostic: `Function \"...\" has non-zero stack delta at fallthrough` (`test/pr92_lowering_interactions.test.ts`)                                                                                                                                                                                                                                                                                                                                                                                                               |
| Untracked SP mutation in op expansion is rejected                               | Intentionally rejected | diagnostic: `expansion performs untracked SP mutation; cannot verify net stack delta` (`test/pr23_lowering_safety.test.ts`)                                                                                                                                                                                                                                                                                                                                                                                                      |
| Untracked SP mutation at `ret`/fallthrough with stack slots is diagnosed        | Intentionally rejected | diagnostics include `ret reached after untracked SP mutation` and `has untracked SP mutation at fallthrough` (`test/pr197_untracked_stack_invariants.test.ts`)                                                                                                                                                                                                                                                                                                                                                                   |
| Unknown stack depth at `ret`/`ret cc`/fallthrough with stack slots is diagnosed | Intentionally rejected | diagnostics include `ret reached with unknown stack depth` and `has unknown stack depth at fallthrough` (`test/pr198_lowering_unknown_stack_states.test.ts`, `test/pr199_lowering_mismatch_propagation.test.ts`, `test/pr218_lowering_retcc_unknown_untracked_matrix.test.ts`, `test/pr219_lowering_retcc_structured_control_matrix.test.ts`, `test/pr220_lowering_retcc_ifelse_repeat_matrix.test.ts`, `test/pr221_lowering_op_expansion_retcc_interactions.test.ts`, `test/pr224_lowering_call_boundary_stack_matrix.test.ts`) |

### 8.3 `10.x` structured control invariants

| Normative intent                                                      | Status                 | Evidence / Diagnostic                                                                                                                  |
| --------------------------------------------------------------------- | ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------- |
| `if/else`, `while`, `repeat/until`, `select/case` parse and lower     | Implemented            | `test/pr15_structured_control.test.ts`                                                                                                 |
| Stack depth must match at control-flow joins/back-edges               | Implemented            | diagnostics asserted in `test/pr15_structured_control.test.ts`, `test/pr92_lowering_interactions.test.ts`                              |
| Join/back-edge mismatches invalidate downstream stack tracking        | Implemented            | mismatch paths now flow into unknown-stack return diagnostics (`test/pr199_lowering_mismatch_propagation.test.ts`)                     |
| Untracked SP mutation at joins/back-edges is diagnosed explicitly     | Implemented            | diagnostics include `Cannot verify stack depth at ... due to untracked SP mutation` (`test/pr197_untracked_stack_invariants.test.ts`)  |
| Unknown stack state at joins/back-edges is diagnosed with stack slots | Implemented            | diagnostics include `Cannot verify stack depth at ... due to unknown stack state` (`test/pr198_lowering_unknown_stack_states.test.ts`) |
| Duplicate `case` values are rejected                                  | Intentionally rejected | diagnostic includes `Duplicate case value` (`test/pr15_structured_control.test.ts`)                                                    |
| `case`/`else`/`until` without matching construct are rejected         | Intentionally rejected | parser diagnostics asserted in `test/pr15_structured_control.test.ts`                                                                  |

## 9) Rejection Diagnostic Catalog (current stable subset)

These are intentionally unsupported or guarded forms with expected diagnostics:

| Area                     | Form                          | Diagnostic (contains)                                     | Evidence                                                                                                                                                                                                                                                                                                                                                     |
| ------------------------ | ----------------------------- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Lowering / EA            | nested indexed EA             | `Nested indexed addresses are not supported yet.`         | `test/pr12_calls.test.ts`                                                                                                                                                                                                                                                                                                                                    |
| Lowering / EA            | non-constant array index      | `Non-constant array indices are not supported yet.`       | parser/lowering negative coverage                                                                                                                                                                                                                                                                                                                            |
| Lowering / control       | select join mismatch          | `Stack depth mismatch at select join`                     | `test/pr15_structured_control.test.ts`, `test/pr92_lowering_interactions.test.ts`                                                                                                                                                                                                                                                                            |
| Lowering / control       | while back-edge mismatch      | `Stack depth mismatch at while back-edge`                 | `test/pr15_structured_control.test.ts`                                                                                                                                                                                                                                                                                                                       |
| Lowering / control       | repeat/until mismatch         | `Stack depth mismatch at repeat/until`                    | `test/pr15_structured_control.test.ts`                                                                                                                                                                                                                                                                                                                       |
| Lowering / control       | untracked join/back-edge      | `Cannot verify stack depth ... untracked SP mutation`     | `test/pr197_untracked_stack_invariants.test.ts`, `test/pr219_lowering_retcc_structured_control_matrix.test.ts`, `test/pr220_lowering_retcc_ifelse_repeat_matrix.test.ts`                                                                                                                                                                                     |
| Lowering / control       | unknown join/back-edge        | `Cannot verify stack depth ... unknown stack state`       | `test/pr198_lowering_unknown_stack_states.test.ts`, `test/pr199_lowering_mismatch_propagation.test.ts`, `test/pr219_lowering_retcc_structured_control_matrix.test.ts`, `test/pr220_lowering_retcc_ifelse_repeat_matrix.test.ts`, `test/pr221_lowering_op_expansion_retcc_interactions.test.ts`                                                               |
| Lowering / returns       | ret with stack imbalance      | `ret with non-zero tracked stack delta`                   | `test/pr23_lowering_safety.test.ts`                                                                                                                                                                                                                                                                                                                          |
| Lowering / returns       | ret/ret cc with unknown stack | `ret reached with unknown stack depth`                    | `test/pr198_lowering_unknown_stack_states.test.ts`, `test/pr199_lowering_mismatch_propagation.test.ts`, `test/pr218_lowering_retcc_unknown_untracked_matrix.test.ts`, `test/pr219_lowering_retcc_structured_control_matrix.test.ts`, `test/pr220_lowering_retcc_ifelse_repeat_matrix.test.ts`, `test/pr221_lowering_op_expansion_retcc_interactions.test.ts` |
| Lowering / function exit | fallthrough stack imbalance   | `has non-zero stack delta at fallthrough`                 | `test/pr92_lowering_interactions.test.ts`                                                                                                                                                                                                                                                                                                                    |
| Lowering / function exit | fallthrough unknown stack     | `has unknown stack depth at fallthrough`                  | `test/pr198_lowering_unknown_stack_states.test.ts`, `test/pr218_lowering_retcc_unknown_untracked_matrix.test.ts`, `test/pr219_lowering_retcc_structured_control_matrix.test.ts`, `test/pr220_lowering_retcc_ifelse_repeat_matrix.test.ts`, `test/pr221_lowering_op_expansion_retcc_interactions.test.ts`                                                     |
| Ops / SP safety          | untracked SP mutation         | `untracked SP mutation`                                   | `test/pr23_lowering_safety.test.ts`, `test/pr218_lowering_retcc_unknown_untracked_matrix.test.ts`, `test/pr219_lowering_retcc_structured_control_matrix.test.ts`                                                                                                                                                                                             |
| Ops / SP safety          | unknown stack tracking        | `expansion leaves stack depth untrackable`                | `test/pr198_lowering_unknown_stack_states.test.ts`, `test/pr199_lowering_mismatch_propagation.test.ts`, `test/pr221_lowering_op_expansion_retcc_interactions.test.ts`                                                                                                                                                                                        |
| Parser / function body   | stray `end` in asm stream     | `Unexpected "end" in asm block`                           | `test/pr216_parser_remaining_decl_control_recovery_matrix.test.ts`                                                                                                                                                                                                                                                                                           |
| Parser / extern          | empty extern block            | `extern block must contain at least one func declaration` | `test/pr216_parser_remaining_decl_control_recovery_matrix.test.ts`                                                                                                                                                                                                                                                                                           |
| Parser / enum            | enum without members          | `must declare at least one member`                        | `test/pr216_parser_remaining_decl_control_recovery_matrix.test.ts`                                                                                                                                                                                                                                                                                           |
| Parser / enum            | enum trailing comma           | `Trailing commas are not permitted in enum member lists`  | `test/pr216_parser_remaining_decl_control_recovery_matrix.test.ts`                                                                                                                                                                                                                                                                                           |
| Parser / type            | empty record declaration      | `must contain at least one field`                         | `test/pr217_parser_decl_minimum_shape_and_eof_recovery.test.ts`                                                                                                                                                                                                                                                                                              |
| Parser / union           | empty union declaration       | `must contain at least one field`                         | `test/pr217_parser_decl_minimum_shape_and_eof_recovery.test.ts`                                                                                                                                                                                                                                                                                              |
| Parser / function        | header at EOF without body    | `Unterminated func "...": expected function body`         | `test/pr217_parser_decl_minimum_shape_and_eof_recovery.test.ts`                                                                                                                                                                                                                                                                                              |
| Parser / op              | body at EOF without `end`     | `Unterminated op "...": missing "end"`                    | `test/pr217_parser_decl_minimum_shape_and_eof_recovery.test.ts`                                                                                                                                                                                                                                                                                              |

## 10) Tranche 3 Mapping Expansion

This tranche extends explicit mapping for additional normative areas and parser span evidence.

### 10.1 Imports, cycles, and search paths (`3.x`)

| Normative intent                                                                                     | Status                 | Evidence / Diagnostic                                                     |
| ---------------------------------------------------------------------------------------------------- | ---------------------- | ------------------------------------------------------------------------- |
| Import graph is resolved deterministically with dependency ordering                                  | Implemented            | `test/pr10_imports.test.ts`                                               |
| Import cycles are rejected with stable diagnostics                                                   | Intentionally rejected | diagnostic contains `Import cycle detected` (`test/pr10_imports.test.ts`) |
| Include search paths are honored in order                                                            | Implemented            | `test/pr11_include_dirs.test.ts`                                          |
| Missing import diagnostics include attempted paths                                                   | Implemented            | `test/pr11_include_dirs.test.ts`                                          |
| `export` is limited to `const`/`func`/`op` and other targets are rejected without parse-side effects | Implemented            | `test/pr157_export_malformed_matrix.test.ts`                              |

### 10.2 Data/layout contracts (`2.2`, `5.x`, `6.x`)

| Normative intent                                                | Status                 | Evidence / Diagnostic                                                                                 |
| --------------------------------------------------------------- | ---------------------- | ----------------------------------------------------------------------------------------------------- |
| Section/address overlaps are diagnosed without noisy cascades   | Implemented            | `test/pr9_sections_align.test.ts`                                                                     |
| String/data length mismatches are rejected                      | Intentionally rejected | diagnostics asserted in `test/pr4_negative.test.ts`, `test/pr215_const_data_followups_matrix.test.ts` |
| Unsupported data storage types are rejected with stable message | Intentionally rejected | diagnostics asserted in `test/pr4_negative.test.ts`, `test/pr215_const_data_followups_matrix.test.ts` |
| Inferred array lengths limited to valid declaration context     | Implemented (subset)   | `test/pr51_data_inferred_array_len.test.ts`, `test/pr54_inferred_array_len_invalid.test.ts`           |

### 10.3 ISA/encoding diagnostics (`7.x`, ISA appendices)

| Normative intent                                                  | Status               | Evidence / Diagnostic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ----------------------------------------------------------------- | -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| rel8 range failures produce deterministic diagnostics             | Implemented          | `test/pr24_isa_core.test.ts`, `test/pr37_fixup_negative.test.ts`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Unsupported condition or operand forms produce stable diagnostics | Implemented (subset) | `test/pr26_rotate_retcc.test.ts`, `test/pr27_cb_rotates_shifts.test.ts`, `test/pr202_add_diag_matrix.test.ts`, `test/pr203_ld_diag_matrix.test.ts`, `test/pr204_adc_sbc_diag_matrix.test.ts`, `test/pr205_indexed_cb_destination_diag_matrix.test.ts`, `test/pr206_in_out_indexed_reg_diag_matrix.test.ts`, `test/pr207_jp_indirect_legality_diag_matrix.test.ts`, `test/pr208_call_indirect_legality_diag_matrix.test.ts`, `test/pr209_jp_cc_indirect_legality_diag_matrix.test.ts`, `test/pr210_jp_call_condition_vs_imm_diag_matrix.test.ts`, `test/pr211_jr_djnz_diag_matrix.test.ts`, `test/pr212_condition_missing_operand_diag_matrix.test.ts`, `test/pr213_condition_symbolic_base_collision_diag_matrix.test.ts`, `test/pr225_indexed_rotate_destination_diag_matrix.test.ts` |
| Forward fixups resolve abs16/rel8 conditionals and calls          | Implemented          | `test/pr37_forward_label_fixups.test.ts`, `test/pr86`/`pr85` anchored in roadmap                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

## 11) Parser Span Evidence (line/column)

The following tests assert line/column-bearing diagnostics to ensure span stability:

| Evidence                                                 | What is asserted                                                                                                               |
| -------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| `test/pr12_calls.test.ts`                                | Wrong-arity call diagnostics include stable `file`, `line`, `column`                                                           |
| `test/semantics_layout.test.ts`                          | Type diagnostics are generated from source spans in semantic evaluation                                                        |
| `test/pr15_structured_control.test.ts`                   | Parser/lowering diagnostics remain single and stable for malformed control constructs                                          |
| `test/parser_nested_index.test.ts`                       | Invalid nested expression path reports deterministic parse failure without cascades                                            |
| `test/pr196_parser_control_interruption_matrix.test.ts`  | Control-stack interruption recovery preserves deterministic diagnostic ordering across function/op bodies                      |
| `test/pr223_parser_var_and_body_recovery_matrix.test.ts` | Function-local `var` interruption and malformed body recovery preserve deterministic diagnostics and top-level resume behavior |
| `test/pr226_parser_decl_control_spans.test.ts`           | Declaration/control recovery diagnostics include stable line/column spans for EOF and explicit `asm` marker failures           |
| `test/pr227_parser_toplevel_malformed_spans.test.ts`     | Top-level malformed-header/export diagnostics include deterministic ordering and line/column spans across keyword families     |

## 12) Remaining Open Items

1. Complete paragraph-level mapping for every remaining normative statement in `docs/zax-spec.md` (including appendices).
2. Add explicit test cases that assert line/column for additional parser failures (not just selected call/type cases).
3. Reconcile uncovered ISA families against spec text and add either tests or explicit rejection diagnostics.
4. Optionally codify this audit as a CI checklist artifact.

## 13) Tranche 4 Appendix Mapping (Source Mapping / D8M)

This tranche maps Appendix B statements to current implementation evidence and known gaps.

| Appendix area                                    | Status               | Evidence / Note                                                                                                                                                                                                 |
| ------------------------------------------------ | -------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `B.1` D8M artifact emitted alongside primary out | Implemented          | `test/cli_artifacts.test.ts` validates `.d8dbg.json` sibling artifact behavior                                                                                                                                  |
| `B.2` path materialization policy                | Implemented (subset) | `test/pr119_d8m_path_normalization.test.ts` validates project-relative, slash-normalized file paths                                                                                                             |
| `B.3` segments map addresses to source           | Implemented (subset) | `test/pr194_d8m_sparse_segments.test.ts` validates sparse contiguous segment runs + core metadata                                                                                                               |
| `B.4` symbol mapping in D8M                      | Implemented (subset) | symbol payload expectations are covered in `test/pr2_const_data.test.ts`, `test/pr3_var_layout.test.ts`, `test/pr4_enum.test.ts`, `test/pr215_const_data_followups_matrix.test.ts`, and extern/ingestion suites |
| `B.5` mapping policy for lowered constructs      | Implemented (subset) | `test/pr200_d8m_appendix_mapping.test.ts` validates grouped `files` entries, local lowered symbols, and constant low16 `address` carry-through                                                                  |
| `B.6` minimal example parity                     | Implemented (subset) | `test/pr200_d8m_appendix_mapping.test.ts` validates canonical D8M envelope + per-file `segments`/`symbols` structure                                                                                            |

## 14) CI Checklist Draft (Spec Audit Gate)

This is a draft checklist to make the spec-audit gate explicit in CI.

| Checkpoint                    | Command / artifact                                                                                                                                                      | Pass condition                                                                    |
| ----------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| Formatting                    | `yarn -s format:check`                                                                                                                                                  | exits `0`                                                                         |
| Type safety                   | `yarn -s typecheck`                                                                                                                                                     | exits `0`                                                                         |
| Full test suite               | `yarn -s test`                                                                                                                                                          | exits `0`                                                                         |
| Artifact determinism          | `test/determinism_artifacts.test.ts`, `test/cli_determinism_contract.test.ts`, `test/cli_path_parity_contract.test.ts`, `test/cli_acceptance_matrix_strictness.test.ts` | test green on all CI OS targets + CLI determinism/path-parity contract            |
| Example compilation           | `test/examples_compile.test.ts`                                                                                                                                         | examples compile on CI matrix                                                     |
| CLI artifact contract         | `test/cli_artifacts.test.ts`, `test/cli_contract_matrix.test.ts`, `test/cli_path_parity_contract.test.ts`, `test/cli_acceptance_matrix_strictness.test.ts`              | sibling outputs + suppression + stdout/arg-validation/path-parity contract stable |
| Structured/lowering safety    | `test/pr23_lowering_safety.test.ts`, `pr92` test                                                                                                                        | stack/control invariants remain enforced                                          |
| Forward references and fixups | `test/pr37_forward_label_fixups.test.ts`                                                                                                                                | forward label and conditional fixups resolve deterministically                    |
| Appendix mapping follow-up    | `docs/spec-v01-audit.md` Section 13                                                                                                                                     | all `Open` rows moved to `Implemented` or `Intentionally rejected` + evidence     |

Checklist usage guidance:

1. A PR that touches parser/lowering/encoder/CLI must run all checklist commands locally before opening review.
2. A PR that modifies mapping output (`.d8dbg.json`/`.lst`) must include at least one contract test update.
3. The roadmap may only mark the spec gate green when Section 13 has no `Open` rows.
